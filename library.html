<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Library - Talevo</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="nav-container">
      <div class="logo">
        <svg class="logo-svg" viewBox="0 0 200 60">
          <path d="M10,15 Q30,5 60,10 T100,10 T140,10 T190,15 Q200,30 190,45 T140,50 T100,50 T60,50 Q30,55 10,45 Q0,30 10,15" 
            fill="none" stroke="currentColor" stroke-width="2">
          </path>
          <text fill="currentColor" font-size="26" font-weight="bold" x="50" y="36" letter-spacing="2">
            Talevo
          </text>
          <circle class="star star1" cx="25" cy="25" fill="currentColor" r="3"></circle>
          <circle class="star star2" cx="175" cy="20" fill="currentColor" r="2.5"></circle>
          <circle class="star star3" cx="155" cy="40" fill="currentColor" r="2"></circle>
          <circle class="star star4" cx="40" cy="45" fill="currentColor" r="1.5"></circle>
          <circle class="star star5" cx="130" cy="15" fill="currentColor" r="2"></circle>
        </svg>
      </div>
      
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="index.html#featured">Featured</a>
        <a href="index.html#trending">Trending</a>
        <a href="index.html#categories">Categories</a>
      </div>
      
      <div class="user-actions">
        <div class="welcome-msg">
          <i class="fas fa-user-circle"></i>
          <span id="username-display">Welcome!</span>
        </div>
        
        <button class="theme-toggle" aria-label="Toggle dark mode">
          <i class="fas fa-sun"></i>
        </button>
        
        <button class="btn login-btn">Sign In</button>

        <div class="account-wrapper hidden">
          <button class="account-button" id="accountToggle">
            <i class="fas fa-user-circle"></i>
            <span id="account-name">Username</span>
            <i class="fas fa-chevron-down dropdown-arrow"></i>
          </button>
          <div class="account-menu hidden">
            <a href="library.html" class="active"><i class="fas fa-book-open"></i> Your Library</a>
            <a href="#" id="signout-link"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="library-main">
    <div class="container">
      <div class="library-header">
        <h1 class="library-title">
          <i class="fas fa-book-open"></i>
          Your Library
        </h1>
        <p class="library-subtitle">Stories you've saved and your reading progress</p>
      </div>

      <!-- Loading State -->
      <div class="loading-container" id="loading-container">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <p>Loading your library...</p>
      </div>

      <!-- Authentication Required Message -->
      <div class="auth-required hidden" id="auth-required">
        <div class="auth-message">
          <i class="fas fa-lock"></i>
          <h2>Sign in to view your library</h2>
          <p>Create an account or sign in to save your favorite stories and track your reading progress.</p>
          <button class="btn login-trigger">Sign In</button>
        </div>
      </div>

      <!-- Library Content -->
      <div class="library-content hidden" id="library-content">
        <!-- Library Stats -->
        <div class="library-stats">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-bookmark"></i>
            </div>
            <div class="stat-info">
              <span class="stat-number" id="saved-count">0</span>
              <span class="stat-label">Saved Stories</span>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-book-reader"></i>
            </div>
            <div class="stat-info">
              <span class="stat-number" id="progress-count">0</span>
              <span class="stat-label">In Progress</span>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
              <span class="stat-number" id="completed-count">0</span>
              <span class="stat-label">Completed</span>
            </div>
          </div>
        </div>

        <!-- Filter Tabs -->
        <div class="library-tabs">
          <button class="tab-btn active" data-tab="all">
            <i class="fas fa-th-large"></i>
            All Stories
          </button>
          <button class="tab-btn" data-tab="reading">
            <i class="fas fa-book-reader"></i>
            Currently Reading
          </button>
          <button class="tab-btn" data-tab="completed">
            <i class="fas fa-check-circle"></i>
            Completed
          </button>
        </div>

        <!-- Stories Grid -->
        <div class="library-grid" id="library-grid">
          <!-- Story cards will be loaded here -->
        </div>

        <!-- Empty State -->
        <div class="empty-library hidden" id="empty-library">
          <div class="empty-state">
            <i class="fas fa-book-open"></i>
            <h2>Your library is empty</h2>
            <p>Start exploring stories and add them to your library to see them here.</p>
            <a href="index.html" class="btn">Explore Stories</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal (same as index.html) -->
  <div class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Welcome to Talevo</h3>
        <button class="modal-close"><i class="fas fa-times"></i></button>
      </div>
      
      <div class="modal-tabs">
        <div class="modal-tab active" data-tab="signin">Sign In</div>
        <div class="modal-tab" data-tab="signup">Sign Up</div>
      </div>
      
      <div class="modal-body">
        <form class="modal-form signin-form active" id="signin-form">
          <div class="form-group">
            <label for="signin-email" class="form-label">Email</label>
            <input type="email" id="signin-email" class="form-input" placeholder="Your email" required>
          </div>
          
          <div class="form-group">
            <label for="signin-password" class="form-label">Password</label>
            <input type="password" id="signin-password" class="form-input" placeholder="Your password" required>
            <a href="#" class="forgot-password">Forgot password?</a>
          </div>
          
          <button type="submit" class="btn form-submit">Sign In</button>
        </form>
        
        <form class="modal-form signup-form" id="signup-form">
          <div class="form-group">
            <label for="signup-username" class="form-label">Username</label>
            <input type="text" id="signup-username" class="form-input" placeholder="Choose a username" required>
          </div>
          
          <div class="form-group">
            <label for="signup-email" class="form-label">Email</label>
            <input type="email" id="signup-email" class="form-input" placeholder="Your email" required>
          </div>
          
          <div class="form-group">
            <label for="signup-password" class="form-label">Password</label>
            <input type="password" id="signup-password" class="form-input" placeholder="Create a password" required>
          </div>
          
          <button type="submit" class="btn form-submit">Sign Up</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase Configuration -->
  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="firebase-auth.js"></script>
  <script type="module" src="script.js"></script>
  
  <script type="module">
    // Library-specific functionality
    class LibraryManager {
      constructor() {
        this.authManager = null;
        this.currentUser = null;
        this.userLibrary = [];
        this.userProgress = {};
        this.currentTab = 'all';
        
        // Wait for auth manager to be ready
        this.waitForAuthManager();
      }

      async waitForAuthManager() {
        // Wait for global authManager to be available
        while (!window.authManager) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        this.authManager = window.authManager;
        
        // Listen for auth state changes
        const auth = window.firebaseAuth;
        const utils = window.firebaseUtils;
        
        utils.onAuthStateChanged(auth, (user) => {
          this.currentUser = user;
          this.handleAuthStateChange(user);
        });
      }

      async handleAuthStateChange(user) {
        const loadingContainer = document.getElementById('loading-container');
        const authRequired = document.getElementById('auth-required');
        const libraryContent = document.getElementById('library-content');

        if (user) {
          // User is signed in - load their library
          authRequired.classList.add('hidden');
          libraryContent.classList.remove('hidden');
          
          await this.loadUserLibrary();
        } else {
          // User is not signed in - show sign in prompt
          loadingContainer.classList.add('hidden');
          libraryContent.classList.add('hidden');
          authRequired.classList.remove('hidden');
        }
      }

      async loadUserLibrary() {
        const loadingContainer = document.getElementById('loading-container');
        const emptyLibrary = document.getElementById('empty-library');
        
        try {
          loadingContainer.classList.remove('hidden');
          
          // Get user data from Firestore
          const db = window.firebaseDb;
          const utils = window.firebaseUtils;
          const userDoc = await utils.getDoc(utils.doc(db, 'users', this.currentUser.uid));
          const userData = userDoc.data() || {};
          
          this.userLibrary = userData.savedStories || [];
          this.userProgress = userData.readingProgress || {};
          
          // Load story data and render
          await this.renderLibrary();
          this.updateStats();
          
        } catch (error) {
          console.error('Error loading user library:', error);
          window.showNotification('Error loading your library. Please try again.', 'error');
        } finally {
          loadingContainer.classList.add('hidden');
        }
      }

      async renderLibrary() {
        const libraryGrid = document.getElementById('library-grid');
        const emptyLibrary = document.getElementById('empty-library');
        
        // Filter stories based on current tab
        let filteredStories = [];
        
        if (this.userLibrary.length > 0) {
          // Get story data (you'll need to implement this based on your story data structure)
          const stories = await this.getStoriesData(this.userLibrary);
          
          switch (this.currentTab) {
            case 'reading':
              filteredStories = stories.filter(story => 
                this.userProgress[story.id] && this.userProgress[story.id].currentChapter > 0
              );
              break;
            case 'completed':
              filteredStories = stories.filter(story => 
                this.userProgress[story.id] && this.userProgress[story.id].completed
              );
              break;
            default:
              filteredStories = stories;
          }
        }

        // Clear current content
        libraryGrid.innerHTML = '';

        if (filteredStories.length === 0) {
          emptyLibrary.classList.remove('hidden');
          libraryGrid.classList.add('hidden');
        } else {
          emptyLibrary.classList.add('hidden');
          libraryGrid.classList.remove('hidden');
          
          // Render story cards
          filteredStories.forEach(story => {
            const card = this.createLibraryStoryCard(story);
            libraryGrid.appendChild(card);
          });
        }
      }

      async getStoriesData(storyIds) {
        // This should match your story data structure from script.js
        const sampleStories = [
          {
            id: 1,
            title: "Space Explorer",
            description: "Navigate the unknown cosmos and discover alien civilizations.",
            genre: "Sci-Fi",
            rating: 4.8,
            image: "https://images.unsplash.com/photo-1446776877081-d282a0f896e2?w=400&h=250&fit=crop"
          },
          {
            id: 2,
            title: "Haunted Manor",
            description: "Uncover the secrets of an old Victorian mansion.",
            genre: "Horror",
            rating: 4.5,
            image: "https://images.unsplash.com/photo-1520637836862-4d197d17c63a?w=400&h=250&fit=crop"
          },
          {
            id: 3,
            title: "Dragon's Quest",
            description: "Embark on a magical journey through enchanted lands.",
            genre: "Fantasy",
            rating: 4.7,
            image: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop"
          }
        ];
        
        // Return stories that match the saved IDs
        return sampleStories.filter(story => storyIds.includes(story.id));
      }

      createLibraryStoryCard(story) {
        const card = document.createElement('div');
        card.className = 'library-story-card';
        
        const progress = this.userProgress[story.id];
        const progressPercentage = progress ? (progress.currentChapter / (progress.totalChapters || 10)) * 100 : 0;
        const isCompleted = progress && progress.completed;
        
        card.innerHTML = `
          <div class="story-image">
            <img src="${story.image}" alt="${story.title}" loading="lazy">
            ${isCompleted ? '<div class="completed-badge"><i class="fas fa-check-circle"></i></div>' : ''}
          </div>
          
          <div class="story-info">
            <div class="story-header">
              <h3 class="story-title">${story.title}</h3>
              <div class="story-meta">
                <span class="genre">
                  <i class="fas fa-tag"></i>
                  ${story.genre}
                </span>
                <span class="rating">
                  <i class="fas fa-star"></i>
                  ${story.rating}
                </span>
              </div>
            </div>
            
            <p class="story-description">${story.description}</p>
            
            ${progress ? `
              <div class="reading-progress">
                <div class="progress-info">
                  <span class="progress-text">
                    ${isCompleted ? 'Completed' : `Chapter ${progress.currentChapter || 1}`}
                  </span>
                  <span class="progress-percentage">${Math.round(progressPercentage)}%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                </div>
              </div>
            ` : ''}
            
            <div class="story-actions">
              <button class="btn read-btn" onclick="this.startReading(${story.id})">
                <i class="fas fa-book-open"></i>
                ${progress && progress.currentChapter > 0 ? 'Continue Reading' : 'Start Reading'}
              </button>
              <button class="btn remove-btn" onclick="libraryManager.removeFromLibrary(${story.id})">
                <i class="fas fa-trash"></i>
                Remove
              </button>
            </div>
          </div>
        `;
        
        return card;
      }

      async removeFromLibrary(storyId) {
        if (!this.currentUser) return;
        
        try {
          // Remove from local array
          this.userLibrary = this.userLibrary.filter(id => id !== storyId);
          
          // Update in Firebase
          const db = window.firebaseDb;
          const utils = window.firebaseUtils;
          const userRef = utils.doc(db, 'users', this.currentUser.uid);
          
          await utils.setDoc(userRef, {
            savedStories: this.userLibrary
          }, { merge: true });
          
          // Re-render library
          await this.renderLibrary();
          this.updateStats();
          
          window.showNotification('Story removed from library', 'success');
          
        } catch (error) {
          console.error('Error removing from library:', error);
          window.showNotification('Error removing story. Please try again.', 'error');
        }
      }

      updateStats() {
        const savedCount = document.getElementById('saved-count');
        const progressCount = document.getElementById('progress-count');
        const completedCount = document.getElementById('completed-count');
        
        const inProgress = Object.values(this.userProgress).filter(p => p.currentChapter > 0 && !p.completed).length;
        const completed = Object.values(this.userProgress).filter(p => p.completed).length;
        
        savedCount.textContent = this.userLibrary.length;
        progressCount.textContent = inProgress;
        completedCount.textContent = completed;
      }

      setupTabNavigation() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        
        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const tab = btn.getAttribute('data-tab');
            
            // Update active tab
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Update current tab and re-render
            this.currentTab = tab;
            this.renderLibrary();
          });
        });
      }
    }

    // Initialize library manager
    const libraryManager = new LibraryManager();
    window.libraryManager = libraryManager;

    // Setup tab navigation
    document.addEventListener('DOMContentLoaded', () => {
      libraryManager.setupTabNavigation();
      
      // Setup login trigger button
      const loginTrigger = document.querySelector('.login-trigger');
      if (loginTrigger) {
        loginTrigger.addEventListener('click', () => {
          document.querySelector('.modal-overlay').classList.add('active');
        });
      }
    });

    // Reading function (you'll need to implement based on your story reader)
    window.startReading = function(storyId) {
      // Redirect to story reader or implement your reading logic
      window.location.href = `story.html?id=${storyId}`;
    };
  </script>

  <style>
    /* Library-specific styles */
    .library-main {
      min-height: calc(100vh - 80px);
      padding: 2rem 0;
    }

    .library-header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .library-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .library-title i {
      margin-right: 1rem;
      color: var(--accent-color);
    }

    .library-subtitle {
      font-size: 1.2rem;
      color: var(--text-secondary);
    }

    .loading-container {
      text-align: center;
      padding: 4rem 0;
    }

    .loading-spinner {
      font-size: 2rem;
      color: var(--accent-color);
      margin-bottom: 1rem;
    }

    .auth-required {
      text-align: center;
      padding: 4rem 2rem;
    }

    .auth-message {
      max-width: 400px;
      margin: 0 auto;
    }

    .auth-message i {
      font-size: 4rem;
      color: var(--accent-color);
      margin-bottom: 1rem;
    }

    .auth-message h2 {
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .auth-message p {
      margin-bottom: 2rem;
      color: var(--text-secondary);
    }

    .library-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      border: 1px solid var(--border-color);
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      background: var(--accent-color);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
    }

    .stat-number {
      display: block;
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-label {
      display: block;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .library-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border-color);
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 1rem 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tab-btn:hover,
    .tab-btn.active {
      color: var(--accent-color);
      border-bottom-color: var(--accent-color);
    }

    .library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 2rem;
    }

    .library-story-card {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .library-story-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .story-image {
      position: relative;
      height: 200px;
      overflow: hidden;
    }

    .story-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .completed-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--success-color);
      color: white;
      padding: 0.5rem;
      border-radius: 50%;
      font-size: 1.2rem;
    }

    .story-info {
      padding: 1.5rem;
    }

    .story-header {
      margin-bottom: 1rem;
    }

    .story-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .story-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .story-description {
      color: var(--text-secondary);
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .reading-progress {
      margin-bottom: 1.5rem;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .progress-text {
      color: var(--text-primary);
      font-weight: 500;
    }

    .progress-percentage {
      color: var(--accent-color);
      font-weight: 600;
    }

    .progress-bar {
      height: 6px;
      background: var(--border-color);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-color);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .story-actions {
      display: flex;
      gap: 1rem;
    }

    .story-actions .btn {
      flex: 1;
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
    }

    .remove-btn {
      background: var(--error-color) !important;
      color: white !important;
    }

    .remove-btn:hover {
      background: #dc2626 !important;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      max-width: 400px;
      margin: 0 auto;
    }

    .empty-state i {
      font-size: 4rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .empty-state h2 {
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .empty-state p {
      margin-bottom: 2rem;
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      .library-stats {
        grid-template-columns: 1fr;
      }
      
      .library-tabs {
        flex-direction: column;
      }
      
      .library-grid {
        grid-template-columns: 1fr;
      }
      
      .story-actions {
        flex-direction: column;
      }
    }
  </style>
</body>
</html>
